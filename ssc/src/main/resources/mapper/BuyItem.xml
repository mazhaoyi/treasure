<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.treasure.ssc.dao.BuyItemDao">
    <select id="selectMoneyNowNo" resultType="java.math.BigDecimal">
        SELECT
            bi.buy_money
        FROM
            buy_item bi
            INNER JOIN ssc_user su ON ( bi.user_id = su.user_id )
            INNER JOIN ticket t ON ( bi.ticket_id = t.ticket_id )
        WHERE
            su.username = #{username}
            AND bi.item_flag = 1
            AND t.ticket_id = #{ticketId}
    </select>
    <update id="updateNowNo">
        update buy_item
        <set>
            item_flag = #{itemFlag},
            update_time = now()
        </set>
        <where>
            ticket_id = #{ticketId}
            and user_id = #{userId}
            and item_flag = 1
        </where>
    </update>
    <update id="updateReNo">
        update buy_item
        <set>
            item_flag = 4,
            update_time = now()
        </set>
        <where>
            user_id = #{userId}
            and item_flag = 1
        </where>
    </update>
    <select id="selectMoneyRe" resultType="java.math.BigDecimal">
        SELECT
            bi.buy_money
        FROM
            buy_item bi
            INNER JOIN ssc_user su ON ( bi.user_id = su.user_id )
            INNER JOIN ticket t ON ( bi.ticket_id = t.ticket_id )
        WHERE
            su.username = #{username}
            AND bi.item_flag = 1
            AND t.ticket_id <![CDATA[<>]]> #{ticketId}
    </select>
    <insert id="insertBatch">
        insert into buy_item(
          user_id, create_time, update_time, item_flag, buy_money, ticket_id
        ) values
        <foreach collection="list" item="bi" separator=",">
            (#{bi.userId}, #{bi.createTime}, #{bi.updateTime}, #{bi.itemFlag}, #{bi.buyMoney}, #{bi.ticketId})
        </foreach>
    </insert>
</mapper>