<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>单据打印</title>
    <link rel="stylesheet" type="text/css" href="css/print.css"/>

    <script src="js/jquery-1.4.4.min.js"></script>
    <script src="js/papaparse.js"></script>
    <script src="js/jschardet.js"></script>
    <!--[if lte IE 9]>
    <script src="js/base64.js"></script>
    <![endif]-->

    <script src="js/csv2arr.js"></script>
    <script language="JavaScript" src="js/jquery.jqprint-0.3.js"></script>
    <script language="JavaScript">
        // 打印预览
        function print() {
            $("#print").jqprint();
        }


        // 生成打印格式总入口
        function csv(){
            $("input[name=csvfile]").csv2arr(function(arr){
                // 循环整个CSV文件，获得每一行信息
                $.each( arr, function(i, line){
                    // 组装要打印的标签
                    var $bodyMainTxt = jointLabel(line);
                    // 偶数页，打印分页
                    if (i % 2 != 0) {
                        $bodyMainTxt.css('page-break-after', 'always');
                    }
                    $('#print').append($bodyMainTxt);
                });
            });
        }

        // 格式化日期
        function exchangeDate(date) {
            if (date == null || date.length == 0) {
                return '';
            }
            // 先截取前8位做为备份
            var subsDate = date.substr(0, 8);
            // 年
            var year = '';
            // 月
            var month = '';
            // 日
            var day = '';

            date = new Date(date);
            // 无效的日期格式，手动截取字符串
            if (date.toLocaleDateString() == 'Invalid Date') {
                year = subsDate.substr(0, 4);
                month = subsDate.substr(4, 2);
                day = subsDate.substr(6, 2);

                return year + '年' + month + '月' + day + '日';
            // 有效的日期格式
            } else {
                year = date.getFullYear();
                month = date.getMonth() + 1;
                day = date.getDate();
                if (month < 10) {
                    month = '0' + month;
                }
                if (day < 10) {
                    day = '0' + day;
                }
                return year + "年" + month + "月" + day + "日";
            }
        }

        // 组装金钱标签
        function joinMoney(money, $bodyMainTxt) {
            if (money == null || money == '') {
                return $bodyMainTxt;
            }

            var strOutUnit = '零壹贰叁肆伍陆柒捌玖';

            money += '00';
            var pointPos = money.indexOf('.');
            // 如果没有.点的话，那么整数+2位小数拼接就可以了
            if (pointPos > 0) {
                money = money.substring(0, pointPos) + money.substr(pointPos + 1, 2);
            }

            for (var i = 0; i < money.length; i++) {
                var j = money.length - i - 1;
                // 当前位的值
                var v = money.substr(i, 1);
                // 当前位置的大写的值
                var vbig = strOutUnit.substr(v, 1);
                // 大写羊角属性
                var atrYj = 'atr_rmb_b' + (j + 1);
                // b属性
                var atrb = 'atr_rmb_b' + j;
                // 小写羊角属性
                var attrYj = 'atr_r_' + (j + 1);
                // 小写属性
                var atrr = 'atr_r_' + j;

                if (i == 0) {
                    // 人民币+大写
                    $bodyMainTxt.find('[atr=' + atrYj + ']').html('¥');
                    $bodyMainTxt.find('[atr=' + atrb + ']').html(vbig);
                    // 人民币+小写
                    $bodyMainTxt.find('[atr=' + attrYj + ']').html('¥');
                    $bodyMainTxt.find('[atr=' + atrr + ']').html(v);
                } else {
                    // 大写
                    $bodyMainTxt.find('[atr=' + atrb + ']').html(vbig);
                    // 小写
                    $bodyMainTxt.find('[atr=' + atrr + ']').html(v);
                }

            }
            return $bodyMainTxt;
        }

        // 拼接打印标签
        function jointLabel(line) {
            // 获取要打印的主体信息,jquery对象
            var $bodyMainTxt = initBodyMain();
            // 编号
            var sno = generatorSno();
            // 名称
            var name = line[3];
            // 日期
            var date = exchangeDate(line[0]);
            // 品名及规格
            var gg = line[1];
            // 金额
            var money = line[2];
            if (money != null && money != '') {
                // 去掉空格
                money = $.trim(money);
                // 去掉中间的逗号
                money = money.replace(/[,]/g, '');
            }
            // 组装金钱标签
            $bodyMainTxt = joinMoney(money, $bodyMainTxt);
            // 组装编号
            $bodyMainTxt.find('[atr=atr_sno]').html(sno);
            // 组装名称
            $bodyMainTxt.find('[atr=atr_name]').html(name);
            // 组装日期
            $bodyMainTxt.find('[atr=atr_date]').html(date);
            // 组装品名及规格
            $bodyMainTxt.find('[atr=atr_gg]').html(gg);
            return $bodyMainTxt;
        }

        // 返回组装打印主体，jQuery对象
        function initBodyMain() {
            // 获取模板
            var bodyMainObj = $.ajax({url: "model/bodyMain", async: false});
            // 获取模板内容
            var bodayMainTxt = bodyMainObj.responseText;
            // 模板内容转换成jQuery对象
            var $jqBodyMain = $(bodayMainTxt);

            return $jqBodyMain;
        }

        function generatorSno() {
            // 获取编号，并写入新编号
            var nowNum = $.ajax({url: "model/nowNum", async: false});
            // 获取编号内容
            var res = nowNum.responseText;
            return res;
        }
    </script>
</head>
<body>
    <h2>1，请选择CSV文件：</h2>
    <input type="file" name="csvfile" />
    <button onclick="csv()" style="border: 1px black solid;height: 20px;width: 130px;">2，点击生成打印格式</button>
    <button onclick="print()" style="border: 1px black solid;height: 20px;width: 130px;">3，点击打印预览</button>
    <div id="print"></div>
</body>
</html>